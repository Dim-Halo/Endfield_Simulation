# 项目代码优化报告与计划

经过对项目的深入分析，我发现虽然项目整体结构清晰（实体/机制/核心分离），但在**代码复用性**和**模块内聚度**上仍有优化空间。以下是具体的分析与优化计划：

## 1. 冗余与繁复代码分析

### A. 角色指令解析 (`parse_command`)
**现状**：几乎每个角色类（如 `ChenSim`, `AdminSim`, `DaPanSim`）都复制粘贴了几乎相同的 `parse_command` 方法。它们都手动解析 "wait", "a1", "skill", "ult", "qte" 字符串。
**问题**：这不仅违反了 DRY (Don't Repeat Yourself) 原则，而且如果未来要修改指令格式（例如支持 "wait 1.5s"），需要修改所有文件。
**优化方案**：在 `BaseActor` 中实现通用的 `parse_command`，子类只需实现 `create_skill` 等工厂方法即可。

### B. QTE 计时器管理
**现状**：每个角色都在 `__init__` 中定义 `self.qte_ready_timer = 0`，并在 `on_tick` 中手动递减它。
**问题**：这是通用的机制逻辑，不应由每个具体的角色去维护。
**优化方案**：将 `qte_ready_timer` 的定义与倒计时逻辑下沉至 `BaseActor`。

### C. 反应管理器 (`ReactionManager`)
**现状**：`apply_hit` 方法过于庞大（约150行），混合了复杂的物理异常状态机逻辑和元素反应逻辑，阅读和维护难度较高。
**问题**：物理逻辑与法术逻辑耦合在一个函数中，修改其中一个容易误伤另一个。
**优化方案**：将 `apply_hit` 拆分为 `_handle_physical_reaction` 和 `_handle_elemental_reaction` 两个私有方法。

## 2. 优化计划 (非破坏性重构)

我将在不改变任何底层战斗逻辑（数值、判定时机）的前提下，执行以下重构：

### 第一步：基类增强 (`BaseActor`)
1.  **通用状态管理**：在 `BaseActor` 中初始化 `qte_ready_timer` 并处理 `on_tick` 递减。
2.  **通用指令解析**：实现默认的 `parse_command`，支持标准指令集：
    *   `wait X` -> `Action("等待", ...)`
    *   `aN` -> `create_normal_attack(N-1)`
    *   `skill`/`e` -> `create_skill()` (带CD检查)
    *   `ult`/`q` -> `create_ult()` (带CD检查)
    *   `qte` -> `create_qte()` (带就绪检查)

### 第二步：核心机制重构 (`ReactionManager`)
1.  **逻辑拆分**：将 `apply_hit` 拆解为物理和法术两个独立的处理函数，提高代码可读性。

### 第三步：角色类瘦身 (`ChenSim`, `AdminSim`, `DaPanSim` 等)
1.  **移除冗余代码**：删除子类中重复的 `parse_command`、`qte_ready_timer` 逻辑。
2.  **保留特性**：仅保留角色特有的逻辑（如特殊的 QTE 触发条件监听、天赋逻辑）。

## 预期收益
*   **代码量减少**：预计减少约 100-200 行重复代码。
*   **可读性提升**：核心逻辑更清晰，角色类只关注技能实现。
*   **扩展性增强**：未来新增角色时，只需关注技能具体效果，无需复制粘贴指令解析模板。

请确认是否执行此优化计划。