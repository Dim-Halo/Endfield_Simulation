# 时间轴事件块碰撞检测功能

## 功能概述

时间轴编辑器现在支持事件块碰撞检测，防止事件在同一轨道上重叠。

## 实现细节

### 1. 碰撞检测逻辑

两个事件A和B发生碰撞的条件：
```
A.startTime < B.endTime AND B.startTime < A.endTime
其中 endTime = startTime + duration
```

### 2. 添加事件时的行为

当用户通过快捷键添加新事件时：

1. **检测碰撞**：检查新事件是否与现有事件重叠
2. **自动调整**：如果发生碰撞，自动寻找下一个可用的时间槽
3. **拒绝添加**：如果找不到可用槽位，拒绝添加并在控制台输出警告

**示例**：
- 用户在2.0秒处按下'S'键添加技能（持续1.5秒）
- 如果2.0-3.5秒范围内已有事件，系统会自动将新事件移到3.5秒之后的第一个可用位置

### 3. 拖动事件时的行为

当用户拖动现有事件时：

1. **实时检测**：检查拖动后的位置是否与其他事件碰撞
2. **智能贴边**：如果新位置会导致碰撞，自动调整到最近的无碰撞位置
3. **边界吸附**：事件会自动贴在相邻事件的边界上

**贴边逻辑**：
- **时间轴边界**：拖动到0秒或最大时长边界时，自动贴边
- **向右拖动碰到事件**：贴在该事件的左边界
- **向左拖动碰到事件**：贴在该事件的右边界
- **拖入间隙**：如果间隙足够大，吸附到最近的边界；如果间隙太小，贴在左侧事件的左边界
- **超出边界**：拖动超出时间轴范围时，自动限制在边界内

**示例**：
- 用户将事件A（持续1.5秒）拖向事件B（位于5.0秒）
- 当事件A接近事件B时，会自动停在3.5秒（5.0 - 1.5）
- 事件A的右边界紧贴事件B的左边界，不会重叠

### 4. 智能贴边算法

```typescript
findNearestValidPosition(targetTime, duration, existingActions, excludeId, maxDuration)
```

**算法流程**：

1. **检查目标位置**：如果目标位置无碰撞，直接返回
2. **查找间隙**：
   - 检查第一个事件之前的空间
   - 检查所有事件之间的间隙
   - 检查最后一个事件之后的空间
3. **吸附到边界**：
   - 如果目标在间隙内且间隙足够大，吸附到最近的边界
   - 如果间隙太小，吸附到左侧事件的左边界
4. **碰撞处理**：
   - 找到与目标位置碰撞的事件
   - 计算到左边界和右边界的距离
   - 选择距离更近的边界进行吸附

### 5. 自动寻找可用槽位算法（添加事件时）

```typescript
findNextAvailableSlot(startTime, duration, existingActions, maxDuration)
```

- 从指定的startTime开始
- 以0.1秒为步长向后搜索
- 找到第一个不与现有事件碰撞的位置
- 如果超出maxDuration，返回原始时间（会被拒绝）

## 用户体验

### 添加事件
1. 用户按快捷键（S/U/Q/A）在鼠标位置添加事件
2. 如果位置被占用，事件会自动移到最近的可用位置
3. 如果整个时间轴都满了，事件不会被添加

### 拖动事件
1. 用户拖动事件块到新位置
2. 如果新位置与其他事件重叠，事件会自动吸附到最近的边界
3. 事件紧贴相邻事件，不会出现重叠或弹回

### 视觉反馈
- 拖动时显示当前时间
- 事件会平滑地吸附到边界（无跳跃感）
- 不会出现事件重叠的情况

## 技术实现

### 修改的文件

**1. `web/src/store/useSimulationStore.ts`**
- 添加`checkCollision()`函数：检测两个事件是否碰撞
- 添加`findNextAvailableSlot()`函数：寻找下一个可用时间槽（用于添加事件）
- 添加`findNearestValidPosition()`函数：寻找最近的无碰撞位置（用于拖动事件）
- 修改`addTimelineAction()`：添加碰撞检测和自动调整
- 修改`updateTimelineAction()`：添加智能贴边逻辑

**2. `web/src/components/TimelineEditor.tsx`**
- 保持现有的拖动逻辑
- 碰撞检测在store层处理，UI层无需修改

## 测试场景

### 场景1：添加事件到空白区域
- 操作：在空白处按'S'键
- 预期：事件正常添加到鼠标位置

### 场景2：添加事件到已占用区域
- 操作：在已有事件的位置按'S'键
- 预期：新事件自动移到下一个可用位置

### 场景3：拖动事件到空白区域
- 操作：拖动事件到空白区域
- 预期：事件正常移动到目标位置

### 场景4：拖动事件到已占用区域
- 操作：尝试将事件拖到另一个事件上
- 预期：事件自动吸附到最近的边界，紧贴相邻事件

### 场景5：拖动事件穿过多个事件
- 操作：拖动事件穿过多个已存在的事件
- 预期：事件吸附到最近的可用边界，不会穿透其他事件

### 场景6：时间轴已满
- 操作：在完全占满的时间轴上添加新事件
- 预期：事件不会被添加，控制台输出警告

## 未来改进

1. **视觉反馈增强**：
   - 拖动时显示吸附目标的高亮边界
   - 显示可用槽位的提示线

2. **磁性吸附**：
   - 在接近边界时自动吸附（磁性效果）
   - 可配置吸附距离阈值

3. **批量操作**：
   - 支持选择多个事件一起移动
   - 自动调整所有事件避免碰撞

4. **配置选项**：
   - 允许用户选择是否启用碰撞检测
   - 允许设置最小间隔时间
   - 允许选择吸附行为（贴边/拒绝/警告）
